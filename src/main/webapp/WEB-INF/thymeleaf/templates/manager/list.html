<!-- src/main/resources/templates/manager/list.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:sd="http://www.thymeleaf.org/spring-data"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/user.html}">
<head>
    <title>Gestion des cartes</title>
</head>
<body>
<div layout:fragment="content" id="cardList">
    <script th:inline="javascript">
        /*<![CDATA[*/
        var printerEppn = /*[[${printerEppn}]]*/ "";
        var availableColumns = /*[[${availableColumns}]]*/ [];
        /*]]>*/
    </script>

    <h2>
        Gestion des cartes
        <a class="btn btn-warning navbar-btn navbar-right" th:href="@{/manager/stats}" id="btnStats" title="Statistiques">
            <span class="glyphicon glyphicon-stats"></span>
        </a>
        <button class="btn btn-primary navbar-btn navbar-right" data-toggle="modal" data-target="#noticeEtats" title="Etats" type="button">
            <span class="glyphicon glyphicon-info-sign"></span>
        </button>
        <button class="btn btn-default navbar-btn navbar-right" data-toggle="modal" data-target="#columnsConfig" title="Colonnes" type="button">
            <span class="glyphicon glyphicon-th-list"></span>
        </button>
        <button class="btn btn-default navbar-btn navbar-right" data-toggle="modal" data-target="#settings" title="Préférences" type="button">
            <span class="glyphicon glyphicon-cog"></span>
        </button>
        <button class="btn btn-info navbar-btn navbar-right hidden-llg hidden-lg hidden-md" data-toggle="collapse" data-target="#searchCollapse" type="button">
            <span class="glyphicon glyphicon-search"></span>
        </button>
        <th:block sec:authorize="hasRole('ROLE_MANAGER')">
            <a class="btn btn-info navbar-btn navbar-right" th:href="@{/manager/ldapSearch}" id="btnLdap" title="Recherche Ldap">
                <span class="glyphicon glyphicon-search"></span>
            </a>
        </th:block>
    </h2>

    <div th:if="${cardsInprintCount > 0}">
        <div class="alert alert-danger">
            Attention, vous avez
            <a th:href="@{/manager(etat='IN_PRINT', ownOrFreeCard=true)}" th:text="${cardsInprintCount} + ' cartes en cours d\'impression'"></a>,
            ne les oubliez pas !
        </div>
    </div>

    <div th:replace="~{templates/manager/includes/megamenu :: megamenu}"></div>
    <div th:replace="~{templates/manager/includes/header :: header}"></div>

    <div id="_title_pl_org_esupportail_sgc_domain_Card_id">
        <div id="listTag">
            <form id="command" action="@{/manager}" method="GET">
                <div style="display:none;" id="preload"></div>
                <table class="table table-striped table-bordered">
                    <thead>
                    <tr>
                        <th data-type="html"><input id="selectall" type="checkbox" th:if="${managePermission}"></th>
                        <th class="hidden">id</th>

                        <!-- En-têtes de colonnes génériques -->
                        <th th:each="col : ${visibleColumns}"
                            th:class="${col.cellCssClass}"
                            th:classappend="${col.centerCell ? 'centerCell' : ''}">
                            <a th:if="${col.sortable}" class="sorting" sd:pagination-sort="${col.sortField}" th:text="${col.label}"></a>
                            <span th:unless="${col.sortable}" th:text="${col.label}"></span>
                        </th>

                        <th data-type="html">Voir</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="card : ${cards}">
                        <td><input th:value="${card.id}" name="case" type="checkbox" class="case" th:if="${managePermission}"/></td>
                        <td class="hidden" th:text="${card.id}"></td>

                        <!-- Cellules génériques avec rendu conditionnel -->
                        <td th:each="col : ${visibleColumns}"
                            th:class="${col.cellCssClass}"
                            th:classappend="${col.centerCell ? 'centerCell' : ''}">

                            <!-- Exception pour la photo avec lazy loading -->
                            <th:block th:if="${col.key == 'photo'}">
                                <a title="Show Card" th:href="@{/manager/{id}(id=${card.id})}">
                                    <div class="lazy-photo"
                                         th:attr="data-src=@{/manager/photo/{id}(id=${card.id})}"
                                         style="width:40px; height:50px; background:#eee; display:inline-block;">
                                    </div>
                                </a>
                            </th:block>

                            <!-- Rendu générique via utext (HTML pré-calculé) -->
                            <th:block th:unless="${col.key == 'photo'}">
                                <span th:utext="${col.getRenderedValue(card)}"></span>
                            </th:block>
                        </td>

                        <td class="utilbox">
                            <a class="btn btn-success" title="Show Card" alt="Show Card" th:href="@{/manager/{id}(id=${card.id})}">
                                <img title="Show Card" th:src="@{/resources/images/show.png}" class="image" alt="Show Card">
                            </a>
                        </td>
                    </tr>
                    </tbody>
                </table>
                <div class="text-center">
                    <nav>
                        <div class="btn-group">
                            <div class="btn-group dropup" sd:page-size-selector="dropdown" style="margin-top: 20px"></div>
                            <ul class="btn-group pagination" sd:pagination="full" sd></ul>
                        </div>
                    </nav>
                    <br/>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de configuration des colonnes -->
    <div class="modal fade" id="columnsConfig" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                    <h4 class="modal-title">Configuration des colonnes</h4>
                </div>
                <form th:action="@{/manager/preferences/columns}" method="POST">
                    <div class="modal-body">
                        <p class="text-muted">Cochez les colonnes que vous souhaitez afficher dans le tableau.</p>
                        <div class="row">
                            <div class="col-md-12">
                                <input class="form-check-input" type="checkbox" id="selectAllColumns">
                                <label class="form-check-label fw-bold" for="selectAllColumns">
                                    Tout sélectionner / Tout désélectionner
                                </label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6" th:each="col : ${availableColumns}">
                                <div class="checkbox">
                                    <label>
                                        <input type="checkbox"
                                               name="columns"
                                               class="columns-checkbox"
                                               th:value="${col.key}"
                                               th:checked="${col.visible}"/>
                                        <span th:text="${col.label}"></span>
                                        <select name="columns_render" class="form-control">
                                            <option th:value="${col.key + ':S'}" th:selected="${col.renderSize.name()=='S'}">Écran S</option>
                                            <option th:value="${col.key + ':M'}" th:selected="${col.renderSize.name()=='M'}">Écran M</option>
                                            <option th:value="${col.key + ':L'}" th:selected="${col.renderSize.name()=='L'}">Écran L</option>
                                            <option th:value="${col.key + ':XL'}" th:selected="${col.renderSize.name()=='XL'}">Écran XL</option>
                                            <option th:value="${col.key + ':XXL'}" th:selected="${col.renderSize.name()=='XXL'}">Écran XXL</option>
                                            <option th:value="${col.key + ':XXXL'}" th:selected="${col.renderSize.name()=='XXXL'}">Écran XXXL</option>
                                        </select>
                                        <small class="text-muted" th:if="${col.description}" th:text="' - ' + ${col.description}"></small>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <script th:inline="javascript">
                            /*<![CDATA[*/
                            document.addEventListener("DOMContentLoaded", function() {
                                const selectAll = document.getElementById("selectAllColumns");
                                const checkboxes = document.querySelectorAll(".columns-checkbox");
                                selectAll.addEventListener("change", () => {
                                    checkboxes.forEach(cb => cb.checked = selectAll.checked);
                                });
                                checkboxes.forEach(cb => cb.addEventListener("change", () => {
                                    const allChecked = [...checkboxes].every(c => c.checked);
                                    const noneChecked = [...checkboxes].every(c => !c.checked);
                                    if (allChecked) {
                                        selectAll.checked = true;
                                        selectAll.indeterminate = false;
                                    } else if (noneChecked) {
                                        selectAll.checked = false;
                                        selectAll.indeterminate = false;
                                    } else {
                                        selectAll.indeterminate = true;
                                    }
                                }));
                            });
                            /*]]>*/
                        </script>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-primary">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div th:replace="~{templates/manager/includes/modals :: modals}"></div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const observer = new IntersectionObserver((entries, obs) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const div = entry.target;
                        const src = div.getAttribute("data-src");
                        if (src) {
                            const img = document.createElement("img");
                            img.src = src;
                            img.height = 50;
                            img.width = 40;
                            div.replaceWith(img);

                            new Popover(img, {
                                trigger: 'hover',
                                placement: 'top',
                                template: '<div class="popover" role="tooltip"><div class="popover-content"><img src="'+ src + '" height="188" width="150"/></div></div>'
                            });

                            obs.unobserve(div);
                        }
                    }
                });
            });

            document.querySelectorAll(".lazy-photo").forEach(div => {
                observer.observe(div);
            });
        });
    </script>

</div>
</body>
</html>